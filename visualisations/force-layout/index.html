<!DOCTYPE html>
<meta charset="utf-8">
<title>Force-Directed Graph</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800" rel="stylesheet">
<style>
.node {
    cursor: pointer;
    /*stroke: #3182bd;*/
    stroke-width: 1px;
}

.link {
    fill: none;
    stroke: #9ecae1;
    stroke-width: 1.5px;
}


.tooltip {
    position: absolute;
    top: 100px;
    left: 100px;
    -moz-border-radius: 5px;
    border-radius: 5px;
    border: 1px solid grey;
    /* background: #222222; */
    background: #fff;
    opacity: 1;
    /* color: #eeeeee; */
    color: black;
    padding: 10px;
    text-align: center;
    width: 400px;
    font-size: 14px;
    z-index: 10;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.19), 0 1px 3px rgba(0, 0, 0, 0.23);
}

.tooltip .dept-name {
    font-size: 16px;
    font-weight: 600;
}

.tooltip .name {
    font-weight: bold;
}

.tooltip-hr {
    margin: 5px 0px;
    border-top: 1px solid rgba(128, 128, 128, 0.64);
}

.tooltip-hr-sec {
    border-top: 1px solid rgba(128, 128, 128, 0.54);
}

.tooltipcurrent-year {
    margin-right: 10px;
    font-weight: 600;
    font-size: 17px;
}

#tooltip-percent {
    font-weight: 600;
    font-size: 17px;
}

.tooltip .positive {
    color: green;
}

.tooltip .negative {
    color: red;
}

.vis-title {
    padding-bottom: 20px;
}

.vis-title h1 {
    font-weight: 600;
    color: #515B5E;
    /* word-spacing: 0px; */
    letter-spacing: -1px;
    font-family: Open Sans;
}

.left-panel {
    padding: 20px;
    padding-top: 50px;

}

.left-panel-text {
    padding: 20px;
}

.col-md-3.left-panel {
    padding-top: 50px;
}

h4.total-exp {
    text-align: center;
    font-weight: 600;
}

.total-exp-val {
    color: black;
    font-weight: 600;
    font-size: 25px;
    padding: 5px;
}

.total-exp {
    font-size: 18px;
    font-weight: 800;
    color: grey;
}

.total-exp-per-change {
    color: rgb(10, 128, 10);
    margin-left: 15px;
    white-space: nowrap;
}
svg{
    border : 1px solid black;
}
</style>

<body>
    <div class="container-fluid">
        <div class="row text-center vis-title">
            <h1> Budget at a Glance</h1>
        </div>
        <div class="row">
            <div class="col-lg-3 left-panel">
                <div class="row">
                    <div class="total-exp text-center">
                        Total Expenditure Budget
                        <div class="total-exp-val">
                            <span class="total-exp-num"></span>
                            <span class="total-exp-per-change"></span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="left-panel-text">
                        Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book.
                    </div>
                </div>
            </div>
            <div class="col-lg-9">
                <div class="visualization-container">
                    <svg></svg>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script type="text/javascript" src="CustomTooltip.js"></script>
    <script>
    var width = 800,
        height = 370,
        root;

    //d3.forceCenter([width/2, height/2])

    var force = d3.layout.force()
        .size([width, height])
        .charge(-1000)

        .on("tick", tick)
        .on("end", function() {

            rendercircle();
        });

    var tooltip = CustomTooltip("obi_tooltip", 260)

    var svg = d3.select(".visualization-container").select("svg")
        .attr("width", width)
        .attr("height", height);

    var link = svg.selectAll(".link"),
        node = svg.selectAll(".node"),
        mov_circles = svg.selectAll('.moving-circles'),
        node_labels = svg.selectAll(".node-label")


    var app_config = {
        selected_year: "Budget Estimates 2018-2019"
    };

    queue()
        .defer(d3.csv, 'data.csv')
        //.defer(d3.json, 'links.json')
        .defer(d3.csv, "links.csv")
        .await(update);

    var gb_data;

    function update(error, nodes_data, links_data) {
        // console.log(links_data)
        gd_data = nodes_data;

        var fixed_notes = {
            "Total Budgetary Expenditure": {
                x: width * 38 / 50,
                y: height * 25 / 50
            },
            "Total Expenditure": {
                x: width * 31 / 50,
                y: height * 20 / 50
            },
            "Total Receipts": {
                x: width * 24 / 50,
                y: height * 27 / 50
            },
            "Total Revenue Receipts": {
                x: width * 18 / 50,
                y: height * 16 / 50
            },
            "Total Capital Receipts": {
                x: width * 18 / 50,
                y: height * 37 / 50
            },
            "Total Non-Tax Revenue": {
                x: width * 23 / 50,
                y: height * 9 / 50
            },
            "Centre's Net Tax Revenue": {
                x: width * 14 / 50,
                y: height * 14 / 50
            },
            "Total Central Expenditure": {
                x: width * 42 / 50,
                y: height * 14 / 50
            },
            "Resources of Public Enterprises": {
                x: width * 31 / 50,
                y: height * 38 / 50
            },
            "Total Non-debt Receipts": {
                x: width * 22 / 50,
                y: height * 40 / 50
            },
            "Transfers": {
                x: width * 40 / 50,
                y: height * 38 / 50
            },
            "Other Central Expenditure": {
                x: width * 40 / 50,
                y: height * 4 / 50
            },
            "Establishment": {
                x: width * 47 / 50,
                y: height * 13 / 50
            },
            "Central Sector Schemes": {
                x: width * 45 / 50,
                y: height * 4 / 50
            },
            "Centre's Net Tax Revenue": {
                x: width * 10 / 50,
                y: height * 15 / 50
            },
            //Central Net Tax Revenue Children
            "Goods and Services Tax (GST)": {
                x: width * 11 / 50,
                y: height * 24 / 50
            },
            "Taxes on Income": {
                x: width * 6.5 / 50,
                y: height * 22.5 / 50
            },
            "Corporation Tax": {
                x: width * 4 / 50,
                y: height * 15 / 50
            },
            "Less - State's share": {
                x: width * 14 / 50,
                y: height * 7 / 50
            },
            "Customs": {
                x: width * 11 / 50,
                y: height * 4 / 50
            },
            "Union Excise Duties": {
                x: width * 5.5 / 50,
                y: height * 4.75 / 50
            },
            "Taxes of Union Territories": {
                x: width * 4 / 50,
                y: height * 9.5 / 50
            },
            "Less - NCCD transferred to NCCF/NDRF": {
                x: width * 8.5 / 50,
                y: height * 4 / 50
            },
            



            //Total Debt Receipts and Children
            "Total Debt Receipts": {
                x: width * 12 / 50,
                y: height * 37 / 50
            },
            "External Loan (Net)": {
                x: width * 8 / 50,
                y: height * 35 / 50
            },
            "Other Receipts (Net)": {
                x: width * 8 / 50,
                y: height * 39 / 50
            },
            "Short term/T-Bill Borrowings": {
                x: width * 9.5 / 50,
                y: height * 42.5 / 50
            },
            "Market Loans (Gross)": {
                x: width * 12 / 50,
                y: height * 45 / 50
            },
            "Securities issued against Small Savings": {
                x: width * 15 / 50,
                y: height * 43 / 50
            },


           /* 



State Provident Fund (Net)

*/


            /*"Total Debt Receipts" : {
              x:width * /50,
              y:height * /50
            }*/
        }




        // Restart the force layout.
        var nodes = [];
        nodes_data.forEach(function(d) {

            var node = {
                id: d["Particular"],
                value: d[app_config["selected_year"]],
                radius_value: +(d[app_config["selected_year"]] > 0 ? d[app_config["selected_year"]] : (-1 * d[app_config["selected_year"]])),
                sno: d["no."],
                fixed: fixed_notes[d["Particular"]] ? true : false,
                label_display: +d["label_display"],
                label_pos: d["label_pos"]

            };


            if (fixed_notes[d["Particular"]]) {
                node.x = fixed_notes[d["Particular"]].x
                node.y = fixed_notes[d["Particular"]].y
            }

            if (node.value != "...") {
                nodes.push(node);
                console.log(node.id == "State Provident Fund (Net)" ? node: " Kuch Nahi")
            } 
        });
        console.log(nodes);
        var max_amount = d3.max(nodes, function(d) { return parseInt(d.radius_value, 10); });

        var radius_scale = d3.scale.pow().exponent(0.5).domain([0, max_amount]).range([2, 35]);



        var links = [];
        links_data.forEach(function(d) {
            var link = {
                source: +d.source,
                target: +d.target,
                source_name: d.source_name,
                destination_name: d.destination_name,
                value: +d.value,
                type: d.type
            }

            links.push(link);
        })

        force
            .nodes(nodes)
            .links(links)
            .start();




        // Update the links…
        link = link.data(links, function(d) { return d.target.id; });

        // Exit any old links.
        link.exit().remove();

        // Enter any new links.
        link.enter().insert("line", ".node")
            .attr("class", "link")
            .style("opacity", 0)
            .style("stroke-width", function(d) { return d.value + "px"; })
            .attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        mov_circles = mov_circles.data(links, function(d) { return d.target.id; });

        // Exit any old links.
        mov_circles.exit().remove();

        mov_circles
            .enter()
            .append("circle")
            .attr("class", "moving-circles")
            .attr("cx", function(d) {
                if (d.type == "reverse") {
                    return d.target.x;
                } else {
                    return d.source.x
                }
            })
            .attr("cy", function(d) {
                if (d.type == "reverse") {
                    return d.target.y;
                } else {
                    return d.source.y
                }
            })
            .attr("r", function(d) { return 1.5; })
            .style("fill", "black")
            .style("opacity", 0);


            console.log(nodes)

            console.log(node)

var test_var = node

        // Update the nodes…
        node = node.data(nodes, function(d, i, test_var) {
            console.log(i , d.id)
            d.r = +radius_scale(d.radius_value)
            return d.r;
        }).style("fill", color);

   nodes.map(function(d, i){
    console.log(i, d)
   })
        // console.log(nodes)
        // Exit any old nodes.
        //node.exit().remove();

        // Enter any new nodes.
        console.log(node)
        node.enter().append("circle")
            .attr("id", function(d, i) {
                console.log(i, d.id);
                return d.id
            })
            .attr("class", "node")
            .attr("cx", function(d, i) { return d.x })
            .attr("cy", function(d) { return d.y; })
            .attr("r", function(d,i) {   return d.r })
            .style("fill", color)
            .style("opacity", 0.2)
            .on("mouseover", function(d, i) { show_details(d, i, this); })
            .on("mouseout", function(d, i) { hide_details(d, i, this); });

        node_labels = node_labels.data(nodes, function(d) { return d.id; });
        console.log(nodes)
        node_labels.enter().append("text")
            .filter(function(d) { return d.label_display == 1 })

            .attr("x", function(d) { return d.x; })
            .attr("y", function(d) { return d.y; })
            .text(function(d) {
                return  d.id
            })
            .attr("text-anchor", "middle")
            .style("font-size", "10px")
            .style("opacity", 0)
    }

    var tick_counter = 0

    function tick() {
        tick_counter = tick_counter + 1
        // console.log("tick called", tick_counter)
        node.style("opacity", function(d) {
            return 0.2 + tick_counter / 300
        })
        node.attr("cx", function(d) { return d.x = Math.max(d.r, Math.min(width - d.r, d.x)); })
            .attr("cy", function(d) { return d.y = Math.max(d.r, Math.min(height - d.r, d.y)); })

        node_labels.attr("x", function(d) { return d.x = Math.max(d.r, Math.min(width - d.r, d.x)); })
            .attr("y", function(d) {
                d.y = Math.max(d.r, Math.min(height - d.r, d.y));

                if (d.label_pos == "top") {
                    return d.y - d.r - 6
                } else {
                    return d.y + d.r + 12
                }
            });




        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });


        /*node.attr("cx", function(d) { return 1.5 * d.x - 250; })
            .attr("cy", function(d) { return 0.5 * d.y + 60; });
        */

        mov_circles.attr("cx", function(d) { return d.source.x; })
            .attr("cy", function(d) { return d.source.y; })
    }

    function rendercircle(data) {

        node.transition()
            .style("opacity", 1).duration(2000);
        link.transition()
            .style("opacity", 1).duration(2000);

        mov_circles.transition()
            .style("opacity", 1).duration(2000);
        node_labels.transition().style("opacity", 1).duration(2000)

        window.setInterval(function(d) {


            mov_circles.transition()
                .attr("cx", function(d) {
                    if (d.type == "reverse") {
                        return d.source.x;
                    } else {
                        return d.target.x
                    }
                })
                .attr("cy", function(d) {
                    if (d.type == "reverse") {
                        return d.source.y;
                    } else {
                        return d.target.y
                    }
                })
                .duration(2000);


            mov_circles.attr("cx", function(d) {
                    if (d.type == "reverse") {
                        return d.target.x;
                    } else {
                        return d.source.x
                    }
                })
                .attr("cy", function(d) {
                    if (d.type == "reverse") {
                        return d.target.y;
                    } else {
                        return d.source.y
                    }
                })

            /*mov_circles.attr("cx", function(d) { return d.source.x; })
                .attr("cy", function(d) { return d.source.y; })*/
        }, 3500);

    }

    var formatComma = d3.format(",")

    function show_details(data, i, element) {


        d3.select(element).attr("stroke-width", 3).attr("z-index", 10000).attr("stroke", "black");
        var content = "<span class='dept-name'>  " + data.id + "  </span><hr class='tooltip-hr' />";
        content += "<span class='tooltipcurrent-year'> <span class=\"value\">  &#8377; " + formatComma(data.value) + " Cr.</span></span>";

        tooltip.showTooltip(content, d3.event);
    }

    function hide_details(data, i, element) {
        d3.select(element).attr("stroke-width", 1)
            .attr("z-index", 1000)
            .attr("stroke", function(d) { return "grey" });
        tooltip.hideTooltip();
    }





    // Color leaf nodes orange, and packages white or blue.
    function color(d) {
        return d._children ? "#3182bd" : d.children ? "#c6dbef" : "#fd8d3c";
    }


    // Returns a list of all nodes under the root.
    function flatten(root) {
        var nodes = [],
            i = 0;

        function recurse(node) {
            if (node.children) node.children.forEach(recurse);
            if (!node.id) node.id = ++i;
            nodes.push(node);
        }

        recurse(root);
        return nodes;
    }


    /*
    var width = 960,
        height = 500;

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

    var app_config = {
      selected_year : "Budget Estimates 2018-2019"
    };

    queue()
      .defer(d3.csv, 'data.csv')
      .defer(d3.json, 'links.json')
      .await(create_chart);

    function create_chart(){
    var force = d3.layout.force()
        .nodes(graph.nodes)
        .links(graph.links)
        .size([width, height])
        .charge(-200)
        .on("tick", tick)
        .start();

    var link = svg.selectAll(".link")
       .data(graph.links)
     .enter().append("line")
       .attr("class", "link");

    var node = svg.selectAll(".node")
       .data(graph.nodes)
     .enter().append("circle")
       .attr("class", "node")
       .attr("r", 4.5);
    }
    function tick() {
      link.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

      node.attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; });
    }
    */
    </script>